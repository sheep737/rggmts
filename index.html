<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ver:2</title>

<style>
body {
  margin: 0;
  background: black;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

canvas {
  background: black;
  image-rendering: pixelated;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
/* =====================
   基本設定
===================== */
const tileSize = 24;
const mapW = 15;
const mapH = 10;

const canvas = document.getElementById("game");
canvas.width = mapW * tileSize;
canvas.height = mapH * tileSize;
const ctx = canvas.getContext("2d");

/* =====================
   マップ
===================== */
let map = [];
for (let y = 0; y < mapH; y++) {
  let row = [];
  for (let x = 0; x < mapW; x++) {
    row.push(
      x === 0 || y === 0 || x === mapW - 1 || y === mapH - 1 ? 1 : 0
    );
  }
  map.push(row);
}

/* =====================
   キャラクター
===================== */
let player = {
  x: 2,
  y: 2,
  dir: { x: 1, y: 0 }
};

let enemy = {
  x: mapW - 3,
  y: mapH - 3,
  dir: { x: -1, y: 0 }
};

/* =====================
   描画
===================== */

function chaseEnemy(enemy, player) {
  const dx = player.x - enemy.x;
  const dy = player.y - enemy.y;

  // 距離が大きい方向を優先
  if (Math.abs(dx) > Math.abs(dy)) {
    enemy.dir = { x: Math.sign(dx), y: 0 };
  } else {
    enemy.dir = { x: 0, y: Math.sign(dy) };
  }
}

function draw() {
  for (let y = 0; y < mapH; y++) {
    for (let x = 0; x < mapW; x++) {
      ctx.fillStyle = map[y][x] === 1 ? "#664422" : "#111";
      ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
    }
  }

  // プレイヤー
  ctx.fillStyle = "#3af";
  ctx.fillRect(
    player.x * tileSize + 4,
    player.y * tileSize + 4,
    tileSize - 8,
    tileSize - 8
  );

  // 敵
  ctx.fillStyle = "#f33";
  ctx.fillRect(
    enemy.x * tileSize + 4,
    enemy.y * tileSize + 4,
    tileSize - 8,
    tileSize - 8
  );
}

/* =====================
   自動移動処理
===================== */
function autoMove(chara) {
  let nx = chara.x + chara.dir.x;
  let ny = chara.y + chara.dir.y;

  if (
    nx < 0 || nx >= mapW ||
    ny < 0 || ny >= mapH ||
    map[ny][nx] === 1
  ) {
    const dirs = [
      { x: 1, y: 0 },
      { x: -1, y: 0 },
      { x: 0, y: 1 },
      { x: 0, y: -1 }
    ];
    chara.dir = dirs[Math.floor(Math.random() * dirs.length)];
    return;
  }

  chara.x = nx;
  chara.y = ny;
}

/* =====================
   メインループ
===================== */
let timer = null;

function loop() {
  autoMove(player);

  // 敵は追いかけてから動く
  chaseEnemy(enemy, player);
  autoMove(enemy);

  if (player.x === enemy.x && player.y === enemy.y) {
    draw();
    clearInterval(timer);
    alert("ゲームオーバー");
    return;
  }

  draw();
}

draw();
timer = setInterval(loop, 300);
</script>

</body>
</html>
