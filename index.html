<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TD ver:1</title>
<style>
  body {
    text-align: center;
    background: #f0f0f0;
  }
  canvas {
    background: #fff;
    border: 2px solid #333;
  }
</style>
</head>
<body>

<h2>シンプル タワーディフェンス</h2>
<p>クリックでタワーを設置</p>
<canvas id="game" width="800" height="400"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const enemies = [];
const towers = [];
const bullets = [];

const towerSpots = [
  { x: 150, y: 100, used: false },
  { x: 150, y: 300, used: false },
  { x: 300, y: 100, used: false },
  { x: 300, y: 300, used: false },
  { x: 450, y: 100, used: false },
  { x: 450, y: 300, used: false },
  { x: 600, y: 150, used: false },
  { x: 600, y: 250, used: false }
];

let frame = 0;

// 敵生成
function spawnEnemy() {
  enemies.push({
    x: 0,
    y: 200,
    hp: 3,
    speed: 1
  });
}

// タワー設置
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;

  towerSpots.forEach(spot => {
    const dist = Math.hypot(spot.x - clickX, spot.y - clickY);

    // 半径20px以内 & 未使用なら設置
    if (dist < 20 && !spot.used) {
      towers.push({
        x: spot.x,
        y: spot.y,
        range: 120,
        cooldown: 0
      });
      spot.used = true;
    }
  });
});

// 更新処理
function update() {
  frame++;

  if (frame % 120 === 0) spawnEnemy();

  // 敵移動
  enemies.forEach(e => e.x += e.speed);

  // タワー攻撃
  towers.forEach(t => {
    if (t.cooldown > 0) {
      t.cooldown--;
      return;
    }
    const target = enemies.find(e =>
      Math.hypot(e.x - t.x, e.y - t.y) < t.range
    );
    if (target) {
      bullets.push({
        x: t.x,
        y: t.y,
        target
      });
      t.cooldown = 60;
    }
  });

  // 弾移動
  bullets.forEach(b => {
    const dx = b.target.x - b.x;
    const dy = b.target.y - b.y;
    const dist = Math.hypot(dx, dy);
    b.x += dx / dist * 4;
    b.y += dy / dist * 4;

    if (dist < 5) {
      b.target.hp--;
      bullets.splice(bullets.indexOf(b), 1);
    }
  });

  // 敵削除
  for (let i = enemies.length - 1; i >= 0; i--) {
    if (enemies[i].hp <= 0 || enemies[i].x > 800) {
      enemies.splice(i, 1);
    }
  }
}

// 描画処理
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 敵
  enemies.forEach(e => {
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(e.x, e.y, 10, 0, Math.PI * 2);
    ctx.fill();
  });

  // タワー
  towers.forEach(t => {
    ctx.fillStyle = "blue";
    ctx.fillRect(t.x - 10, t.y - 10, 20, 20);
  });

  // 弾
  bullets.forEach(b => {
    ctx.fillStyle = "black";
    ctx.beginPath();
    ctx.arc(b.x, b.y, 3, 0, Math.PI * 2);
    ctx.fill();
  });

// 描画処理の中（draw関数）
towerSpots.forEach(s => {
  ctx.strokeStyle = s.used ? "#aaa" : "#00aa00";
  ctx.beginPath();
  ctx.arc(s.x, s.y, 15, 0, Math.PI * 2);
  ctx.stroke();
});

}

// ゲームループ
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>