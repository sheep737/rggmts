<script>
const STORAGE_KEY = 'sked_persistent_data';
const dates = ["1/19(月)","1/20(火)","1/21(水)","1/22(木)","1/23(金)","1/24(土)","1/25(日)"];

let foldState = {};
let menuOpen = false;
let activeCell = null;
let editingElement = null;

/* ===== MENU ===== */
function toggleMenu(){
    const menu = document.getElementById('side-menu');
    const overlay = document.getElementById('menu-overlay');

    menuOpen = !menuOpen;
    menu.classList.toggle('open', menuOpen);
    overlay.classList.toggle('show', menuOpen);

    saveData();
}

/* ===== FOLD ===== */
function toggleFold(id, e){
    if(e.target.closest('.time-badge')) return;

    const card = document.getElementById(`card-${id}`);
    const collapsed = !card.classList.contains('collapsed');

    card.classList.toggle('collapsed', collapsed);
    foldState[id] = collapsed;

    saveData();
}

/* ===== INIT ===== */
function init(){
    const list = document.getElementById('days-list');
    dates.forEach((d,i)=>{
        const id = i + 1;
        list.insertAdjacentHTML('beforeend', `
        <div class="day-card" id="card-${id}">
            <div class="day-header" onclick="toggleFold(${id},event)">
                <span class="day-title">${d}</span>
                <span class="time-badge">計0分</span>
            </div>
            <div class="day-content">
                <div id="t-${id}" class="drop-zone"></div>
                <button class="add-btn" onclick="openModal(document.getElementById('t-${id}'))">+ 追加</button>
            </div>
        </div>`);
    });

    loadData();
    updateAll();
}

/* ===== MODAL ===== */
function openModal(cell, el=null){
    activeCell = cell;
    editingElement = el;

    document.getElementById('inputTxt').value =
        el ? el.querySelector('strong').textContent : "";
    document.getElementById('inputTime').value =
        el ? el.querySelector('.t-val').textContent : "";
    document.getElementById('inputPrio').value =
        el ? el.dataset.prio : "C";

    document.getElementById('modal').style.display = 'flex';
}
function closeModal(){
    document.getElementById('modal').style.display = 'none';
}
function confirmModal(){
    if(!document.getElementById('inputTxt').value) return;

    editingElement ? updateItem(editingElement) : addItem(activeCell);

    closeModal();
    updateAll();
    saveData();
}

/* ===== TASK ===== */
function addItem(cell){
    const el = document.createElement('div');
    el.className = 'item';
    updateItem(el);
    cell.appendChild(el);
}
function updateItem(el){
    const txt = document.getElementById('inputTxt').value;
    const time = document.getElementById('inputTime').value || 0;
    const prio = document.getElementById('inputPrio').value;

    el.dataset.prio = prio;
    el.innerHTML = `
        <strong>${txt}</strong>
        <span style="margin-left:8px;font-size:.75rem;color:#888">
            ⏳<span class="t-val">${time}</span>分
        </span>`;
}

/* ===== CALC ===== */
function updateAll(){
    let total = 0;
    document.querySelectorAll('.t-val').forEach(v => total += +v.textContent || 0);
    document.getElementById('total-time-display').textContent = `${total} 分`;
}

/* ===== STORAGE ===== */
function saveData(){
    const data = {
        items: [],
        foldState,
        menuOpen,
        freeMemo: document.getElementById('free-memo').value
    };

    document.querySelectorAll('.item').forEach(i=>{
        data.items.push({
            parent: i.parentElement.id,
            text: i.querySelector('strong').textContent,
            time: i.querySelector('.t-val').textContent,
            prio: i.dataset.prio
        });
    });

    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadData(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;

    const d = JSON.parse(raw);

    /* menu */
    if(d.menuOpen){
        menuOpen = true;
        document.getElementById('side-menu').classList.add('open');
        document.getElementById('menu-overlay').classList.add('show');
    }

    /* memo */
    document.getElementById('free-memo').value = d.freeMemo || "";

    /* fold */
    foldState = d.foldState || {};
    Object.entries(foldState).forEach(([id,val])=>{
        if(val) document.getElementById(`card-${id}`)?.classList.add('collapsed');
    });

    /* items */
    d.items?.forEach(i=>{
        const cell = document.getElementById(i.parent);
        if(cell){
            document.getElementById('inputTxt').value = i.text;
            document.getElementById('inputTime').value = i.time;
            document.getElementById('inputPrio').value = i.prio;
            addItem(cell);
        }
    });
}

window.onload = init;
</script>
